x-airflow-common: &airflow-common
  build: .
  user: "${AIRFLOW_UID:-50000}:0"
  env_file:
    - .env
  environment:
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
    AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY}
    AIRFLOW__CORE__SIMPLE_AUTH_MANAGER_USERS: "admin:admin"
    AIRFLOW__CORE__EXECUTION_API_SERVER_URL: "http://airflow-api-server:8080/execution/"
    AIRFLOW__API_AUTH__JWT_SECRET: ${AIRFLOW_JWT_SECRET}
    PYTHONPATH: /opt/airflow/plugins
    MONGO_DB_USER: ${MONGO_DB_USER}
    MONGO_DB_PASS: ${MONGO_DB_PASS}
    GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    PYDANTIC_AI_MODEL: ${PYDANTIC_AI_MODEL}
  volumes:
    - ./dags:/opt/airflow/dags
    - ./logs:/opt/airflow/logs
    - ./plugins:/opt/airflow/plugins
  depends_on:
    postgres:
      condition: service_healthy

services:
  postgres:
    image: postgres:16
    container_name: airflow-postgres
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U airflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data

  airflow-init:
    <<: *airflow-common
    container_name: airflow-init
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db migrate
        python3 -c "from sqlalchemy import create_engine, text; import os; engine = create_engine(os.environ['AIRFLOW__DATABASE__SQL_ALCHEMY_CONN']); conn = engine.connect(); conn.execute(text(\"DELETE FROM connection WHERE conn_id = 'mongo_vitor_ozols'\")); conn.commit(); conn.close()"
        airflow connections add "mongo_vitor_ozols" \
          --conn-type "mongo" \
          --conn-host "vitor-ozols.jnzjp8i.mongodb.net" \
          --conn-login "${MONGO_DB_USER}" \
          --conn-password "${MONGO_DB_PASS}" \
          --conn-schema "airflow" \
          --conn-extra '{"srv": true, "tls": true, "authSource": "admin", "retryWrites": true, "w": "majority", "appname": "airflow"}'

  airflow-api-server:
    <<: *airflow-common
    container_name: airflow-api-server
    command: api-server
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully

  airflow-dag-processor:
    <<: *airflow-common
    container_name: airflow-dag-processor
    command: dag-processor
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully

  airflow-scheduler:
    <<: *airflow-common
    container_name: airflow-scheduler
    command: scheduler
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully

volumes:
  postgres_data:
